{{ define "main" }}

  {{ $webmentions := false }}
  {{ if ne hugo.Environment "development" }}
    {{ $webmentions = getJSON "https://webmention.io/api/mentions.jf2?target=" .Permalink }}
  {{ end }}

  <article class="h-entry article{{ range .Params.categories }} article--{{ .|lower }}{{ end }}">
    <header>
      <h1 class="p-name">
        {{ if .Resources.Match "game/*" }}{{ emojify ":joystick:" }}{{ end }}
        {{ if .Params.draft }}<mark>Draft</mark>{{ end }}
        {{ .Title }}
      </h1>
      {{ if .Params.subtitle }}<p>{{ .Params.subtitle }}</p>{{ end }}
      {{ partial "article-info.html" . }}

      {{ $headerResource := .Page.Resources.GetMatch "header" }}
      {{ if $headerResource }}
        {{ $headerImage := $headerResource.Fill "900x400" }}
        <figure>
          <img src="{{ $headerImage.RelPermalink }}" srcset="" alt="{{ $headerImage.Title }}" title="{{ $headerImage.Title }}" width="{{ $headerImage.Width }}" height="{{ $headerImage.Height }}">
        </figure>
      {{ end }}

      {{ partial "toc" . }}

      {{ if .Resources.Match "game/*" }}
        <details>
          <summary id="achievements-headline">üèÜ Achievements</summary>
          <ol id="achievements-list" class="achievements-list"></ol>
        </details>
      {{ end }}
    </header>

    <div class="e-content">{{ .Content }}</div>
    {{ if $webmentions }}{{ partial "mention-count" $webmentions }}{{ end }}
    {{ if $webmentions }}{{ partial "conversation" $webmentions }}{{ end }}

    {{ partial "syndicated.html" . }}

    {{ with .Resources.Match "game/*" }}
      {{ range $index, $value := . }}
        {{ $id := replace .Name "game/" "-" }}
        <div id="game-scene{{ replace $id ".md" "" }}" class="game-scene"{{ if gt $index 0 }} hidden{{ end }}>
          {{ .Content }}
          <div class="game-buttons">
            {{ if .Params.is_terminal }}
              <button class="game-button" data-target-id="restart">Try again</button>
            {{ else }}
              {{ range .Params }}
                {{ if isset . "id" }}
                  <button
                    class="game-button"
                    data-target-id="game-scene-{{ .id }}"
                    {{ with .achievement }}
                      data-achievement-text="{{ .text }}"
                      data-achievement-type="{{ .type }}"
                    {{ end }}
                  >
                    {{ .text }}
                  </button>
                {{ end }}
              {{ end }}
            {{ end }}
          </div>
        </div>
      {{ end }}
      <aside id="achievement" class="achievement" data-achievement-type="good">
        <h3 class="achievement__headline">Achievement unlocked!</h3>
        <p id="achievement-message" class="achievement__message"></p>
      </aside>
      <aside id="achievement-max" class="achievement achievement--max">
        <h3 class="achievement__headline">‚≠êÔ∏è You fully beat the game!</h3>
        <p id="achievement-message" class="achievement__message">Congradulations! You followed <em>every</em> possible path. The ultimate winner is you!</p>
        <button>Nice!</button>
      </aside>
    {{ end }}

    <footer>
      {{ partial "pagination.html" . }}
    </footer>
  </article>

{{ end }}
