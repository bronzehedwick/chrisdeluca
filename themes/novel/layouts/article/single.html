{{ define "main" }}

  {{ $webmentions := false }}
  {{ if ne .Hugo.Environment "development" }}
    {{ $webmentions = getJSON "https://webmention.io/api/mentions.jf2?target=" .Permalink }}
  {{ end }}

  <article class="article{{ range .Params.categories }} article--{{ .|lower }}{{ end }}">
    <header>
      <h1>
        {{ if .Resources.Match "game/*" }}{{ emojify ":joystick:" }}{{ end }}
        {{ if .Params.draft }}<mark>Draft</mark>{{ end }}
        {{ .Title }}
      </h1>
      {{ if .Params.subtitle }}<p>{{ .Params.subtitle }}</p>{{ end }}
      {{ partial "article-info.html" . }}

      {{ $headerResource := .Page.Resources.GetMatch "header" }}
      {{ if $headerResource }}
        {{ $headerImage := $headerResource.Fill "900x400" }}
        <figure>
          <img src="{{ $headerImage.RelPermalink }}" srcset="" alt="{{ $headerImage.Title }}" title="{{ $headerImage.Title }}" width="{{ $headerImage.Width }}" height="{{ $headerImage.Height }}">
        </figure>
      {{ end }}

      {{ if .IsPage }}
        {{ if .Params.toc }}
          <details>
            <summary>Table of Contents</summary>
            {{ .TableOfContents }}
          </details>
        {{ end }}
      {{ end }}

      {{ if .Resources.Match "game/*" }}
        <details>
          <summary id="achievements-headline">üèÜ Achievements</summary>
          <ol id="achievements-list" class="achievements-list"></ol>
        </details>
      {{ end }}
    </header>

    {{ .Content }}
    {{ if $webmentions }}{{ partial "mention-count" $webmentions }}{{ end }}

    {{ with .Resources.Match "game/*" }}
      {{ range $index, $value := . }}
        {{ $id := replace .Name "game/" "-" }}
        <div id="game-scene{{ replace $id ".md" "" }}" class="game-scene"{{ if gt $index 0 }} hidden{{ end }}>
          {{ .Content }}
          <div class="game-buttons">
            {{ if .Params.is_terminal }}
              <button class="game-button" data-target-id="restart">Try again</button>
            {{ else }}
              {{ range .Params }}
                {{ if isset . "id" }}
                  <button
                    class="game-button"
                    data-target-id="game-scene-{{ .id }}"
                    {{ with .achievement }}
                      data-achievement-text="{{ .text }}"
                      data-achievement-type="{{ .type }}"
                    {{ end }}
                  >
                    {{ .text }}
                  </button>
                {{ end }}
              {{ end }}
            {{ end }}
          </div>
        </div>
      {{ end }}
      <aside id="achievement" class="achievement" data-achievement-type="good">
        <h3 class="achievement__headline">üèÜ Achievement unlocked!</h3>
        <p id="achievement-message" class="achievement__message"></p>
      </aside>
    {{ end }}

    <footer>
      <nav>
        <ul class="pagination article-navigation">
          {{ if .PrevInSection }}
            <li class="pagination__item pagination__prev article-navigation__item article-navigation__prev">
              <a title="Previous {{ .Type }}" href="{{ .PrevInSection.Permalink }}">&larr; {{ .PrevInSection.Title }}</a>
            </li>
          {{ end }}

          {{ if .NextInSection }}
            <li class="pagination__item pagination__next article-navigation__item article-navigation__next">
              <a title="Next {{ .Type }}" href="{{ .NextInSection.Permalink }}">{{ .NextInSection.Title }} &rarr;</a>
            </li>
          {{ end }}
        </ul>
      </nav>
      {{ if $webmentions }}{{ partial "conversation" $webmentions }}{{ end }}
    </footer>
  </article>

{{ end }}
